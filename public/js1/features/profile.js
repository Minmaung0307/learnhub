import { el, toast } from '../services/ui.js'; import { getFirebase } from '../services/firebase.js'; import { onAuth } from '../services/auth.js';
export async function viewProfile(){ const app=document.getElementById('app'); app.innerHTML=''; const user=await new Promise(r=>onAuth(r)); if(!user){ app.append(el('p',{},'Please login.')); return; }
  const {db,doc,getDoc}=await getFirebase(); app.append(el('h2',{},'Profile'));
  app.append(el('section',{class:'card'},[ el('div',{class:'kv'},[el('b',{},'Name'),el('span',{},user.displayName||'—')]), el('div',{class:'kv'},[el('b',{},'Email'),el('span',{},user.email)]), el('div',{class:'kv'},[el('b',{},'UID'),el('span',{},user.uid)]) ]));
  const prog=await getDoc(doc(db,'users',user.uid,'progress','js-101')).catch(()=>null); const pct=prog?.exists()?(prog.data().percent||0):0;
  app.append(el('div',{class:'card mt-2'},[ el('h3',{},'Learning Progress'), el('div',{class:'progress mt-2'},[el('i',{style:`width:${pct}%`})]) ]));
  app.append(el('div',{class:'row gap mt-2'},[ el('button',{class:'btn',onclick:()=>viewCard()},'View Card'), el('button',{class:'btn',onclick:()=>downloadCert()},'Download Certificate'), el('button',{class:'btn ghost',onclick:()=>downloadTranscript()},'Download Transcript') ]));
  function viewCard(){ const dlg=document.createElement('dialog'); dlg.innerHTML=`<div class='card' style='min-width:520px'><h3>Student Card</h3><div class='row gap mt-2'><img src='${user.photoURL||"https://api.dicebear.com/7.x/thumbs/svg?seed=LH"}' style='width:72px;height:72px;border-radius:8px'/><div><div><b>${user.displayName||"—"}</b></div><div class='muted'>${user.email}</div><div class='badge'>UID: ${user.uid}</div></div></div><div class='row gap right mt-2'><button class='btn' id='ok'>Close</button></div></div>`; document.body.appendChild(dlg); dlg.showModal(); dlg.querySelector('#ok').onclick=()=>dlg.close(); dlg.addEventListener('close',()=>dlg.remove()); }
  async function downloadCert(){ const {jsPDF}=window.jspdf||{}; if(!jsPDF) return toast('jsPDF missing','bad'); const d=new jsPDF({orientation:'landscape'}); d.setFontSize(24); d.text('Certificate of Completion',20,30); d.setFontSize(14); d.text(`This certifies that ${user.displayName||user.email} has completed a course.`,20,50); d.save('certificate.pdf'); }
  async function downloadTranscript(){ const {jsPDF}=window.jspdf||{}; if(!jsPDF) return toast('jsPDF missing','bad'); const d=new jsPDF({orientation:'portrait'}); d.setFontSize(20); d.text('Transcript',20,20); d.setFontSize(12); d.text(`Name: ${user.displayName||'—'}`,20,36); d.text(`Email: ${user.email}`,20,44); d.save('transcript.pdf'); }
}